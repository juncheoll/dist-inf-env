name: CI/CD for Distributed Inference Nodes

on:
  push:
    branches:
      - main  # main ë¸Œëœì¹˜ì— í‘¸ì‹œë  ë•Œë§Œ ë™ì‘

jobs:
  update-nodes:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node: [ "node1", "node2", "node3" ]  # ì—¬ê¸°ì— ì‹¤ì œ ì„œë²„ì˜ IP ë˜ëŠ” í˜¸ìŠ¤íŠ¸ëª… ì¶”ê°€

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set up SSH
      uses: webfactory/ssh-agent@v0.5.3
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

    - name: Update remote node
      run: |
        ssh -o StrictHostKeyChecking=no user@${{ matrix.node }} << 'EOF'
          echo "ğŸ“¢ ì—°ê²°ë¨: ${{ matrix.node }}"

          # 1ï¸âƒ£ ì‹¤í–‰ ì¤‘ì¸ Python í”„ë¡œì„¸ìŠ¤ë¥¼ ì¢…ë£Œ
          echo "ğŸ›‘ ì‹¤í–‰ ì¤‘ì¸ Python í”„ë¡œì„¸ìŠ¤ë¥¼ ì¢…ë£Œí•©ë‹ˆë‹¤."
          docker ps -q --filter "name=my_vllm_container" | xargs -r docker exec {} pkill python

          # 2ï¸âƒ£ vLLM ì½”ë“œ ë””ë ‰í„°ë¦¬ë¡œ ì´ë™ ë° ì—…ë°ì´íŠ¸
          echo "ğŸ”„ ìµœì‹  vLLM ì†ŒìŠ¤ì½”ë“œ ê°€ì ¸ì˜¤ê¸°"
          cd /path/to/your/vllm/repo  # ì´ ê²½ë¡œëŠ” ê° ë…¸ë“œì— í´ë¡ ëœ ë¦¬í¬ì§€í† ë¦¬ì˜ ìœ„ì¹˜ë¡œ ë°”ê¿”ì•¼ í•©ë‹ˆë‹¤.
          git fetch --all
          git reset --hard origin/main

          # 3ï¸âƒ£ Docker ì»¨í…Œì´ë„ˆ ì¬ì‹œì‘ (ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ìœ ì§€)
          echo "ğŸš€ Docker ì»¨í…Œì´ë„ˆ ë‚´ë¶€ì—ì„œ Python í”„ë¡œì„¸ìŠ¤ ì¬ì‹œì‘"
          docker ps -q --filter "name=my_vllm_container" | xargs -r docker exec {} bash -c "source /myenv/bin/activate && python3 path/to/your/python/script.py"

          echo "âœ… ì™„ë£Œ: ${{ matrix.node }}"
        EOF
